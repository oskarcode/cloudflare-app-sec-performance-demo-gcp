{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Cloudflare Security Demo - Presentation{% endblock %}

{% block content %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        padding: 80px 0;
        margin: -30px -15px 30px -15px;
    }
    .section-padding {
        padding: 60px 0;
    }
    .card-hover {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .pain-point {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
    }
    .solution {
        background: #dcfce7;
        border-left: 4px solid #22c55e;
    }
    .metric {
        font-size: 2.5rem;
        font-weight: bold;
        color: #f97316;
    }
    .nav-pills .nav-link.active {
        background-color: #f97316;
    }
    .btn-primary {
        background-color: #f97316;
        border-color: #f97316;
    }
    .btn-primary:hover {
        background-color: #ea580c;
        border-color: #ea580c;
    }
</style>

<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-4">
                    <i class="fas fa-shield-alt"></i> Cloudflare Security Demo
                </h1>
                <p class="lead mb-4">
                    AI-powered dynamic presentation for e-commerce security demonstrations
                </p>
                <span class="badge bg-light text-dark">
                    <i class="fas fa-robot"></i> Content powered by MCP
                </span>
            </div>
            <div class="col-lg-4">
                <div class="text-center">
                    <i class="fas fa-globe-americas" style="font-size: 200px; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Navigation Menu -->
<div class="container">
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-pills nav-justified mb-4" id="demo-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="#case-content" data-bs-toggle="pill">
                        <i class="fas fa-briefcase"></i> Case Background
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#architecture-content" data-bs-toggle="pill">
                        <i class="fas fa-sitemap"></i> Architecture
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#cloudflare-help-content" data-bs-toggle="pill">
                        <i class="fas fa-hands-helping"></i> How Cloudflare Helps
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#value-content" data-bs-toggle="pill">
                        <i class="fas fa-chart-line"></i> Business Value
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="demo-tab-content">
        
        <!-- Case Background -->
        <div class="tab-pane fade show active" id="case-content">
            <div class="row section-padding">
                <div class="col-lg-6">
                    <h2><i class="fas fa-building"></i> Business Context</h2>
                    {% if case_background.business_context %}
                    <div class="card card-hover mb-4">
                        <div class="card-body">
                            <h5><i class="fas fa-store"></i> {{ case_background.business_context.title }}</h5>
                            <p>{{ case_background.business_context.description }}</p>
                            {% if case_background.business_context.stats %}
                            <ul class="list-unstyled">
                                {% for stat in case_background.business_context.stats %}
                                <li><i class="fas fa-{{ stat.icon }} text-primary"></i> <strong>{{ stat.label }}:</strong> {{ stat.value }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if case_background.current_solution %}
                    <h3><i class="fas fa-wrench"></i> Current Solution</h3>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>{{ case_background.current_solution.title }}</strong>
                        <p>{{ case_background.current_solution.description }}</p>
                        {% if case_background.current_solution.problems %}
                        <ul class="mt-2">
                            {% for problem in case_background.current_solution.problems %}
                            <li>{{ problem }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="col-lg-6">
                    <h3><i class="fas fa-exclamation-circle text-danger"></i> Critical Pain Points</h3>
                    
                    {% if case_background.pain_points %}
                        {% for pain_point in case_background.pain_points %}
                        <div class="card pain-point mb-3">
                            <div class="card-body">
                                <h6><i class="fas fa-{{ pain_point.icon }}"></i> <strong>{{ pain_point.title }}</strong></h6>
                                <p class="mb-1">{{ pain_point.description }}</p>
                                {% if pain_point.test_links %}
                                <div class="mt-2">
                                    {% for link in pain_point.test_links %}
                                    <a href="{{ link.url }}" class="btn btn-sm btn-outline-danger me-2" target="_blank">{{ link.text }}</a>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Architecture Content -->
        <div class="tab-pane fade" id="architecture-content">
            <div class="section-padding">
                <h2 class="text-center mb-5"><i class="fas fa-sitemap"></i> Architecture</h2>
                
                {% if architecture.problems_mapping %}
                <div class="row mb-5">
                    <div class="col-12">
                        <h3><i class="fas fa-exclamation-triangle"></i> Current Problems & Solutions</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Problem</th>
                                        <th>Technical Cause</th>
                                        <th>Cloudflare Solution</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mapping in architecture.problems_mapping %}
                                    <tr>
                                        <td><strong>{{ mapping.problem }}</strong></td>
                                        <td>{{ mapping.current_solution }}
                                            {% if mapping.limitations %}
                                            <ul class="mt-2">
                                                {% for limitation in mapping.limitations %}
                                                <li>{{ limitation }}</li>
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                        </td>
                                        <td><span class="badge bg-success">{{ mapping.cloudflare_solution }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if architecture.traffic_flow %}
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <h5><i class="fas fa-arrow-right"></i> Before Cloudflare</h5>
                            </div>
                            <div class="card-body">
                                <ol class="list-group list-group-numbered">
                                    {% for step in architecture.traffic_flow.before %}
                                    <li class="list-group-item">{{ step }}</li>
                                    {% endfor %}
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h5><i class="fas fa-check-circle"></i> After Cloudflare</h5>
                            </div>
                            <div class="card-body">
                                <ol class="list-group list-group-numbered">
                                    {% for step in architecture.traffic_flow.after %}
                                    <li class="list-group-item">{{ step }}</li>
                                    {% endfor %}
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- How Cloudflare Helps -->
        <div class="tab-pane fade" id="cloudflare-help-content">
            <div class="section-padding">
                <h2 class="text-center mb-5"><i class="fas fa-hands-helping"></i> How Cloudflare Helps</h2>
                
                {% if how_cloudflare_help.solutions %}
                <div class="row">
                    {% for solution in how_cloudflare_help.solutions %}
                    <div class="col-lg-6 mb-4">
                        <div class="card solution card-hover h-100">
                            <div class="card-body">
                                <h5><i class="fas fa-shield-alt"></i> {{ solution.pain_point }}</h5>
                                <p class="mb-2"><strong>Capability:</strong> {{ solution.cloudflare_solution }}</p>
                                <p class="text-muted"><small>{{ solution.how_it_works }}</small></p>
                                <div class="mt-3">
                                    <div class="alert alert-success mb-0">
                                        <strong><i class="fas fa-check-circle"></i> Benefits:</strong>
                                        {% if solution.benefits %}
                                        <ul class="mb-0 mt-2">
                                            {% for benefit in solution.benefits %}
                                            <li>{{ benefit }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if how_cloudflare_help.network_advantages %}
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h4 class="text-center mb-4"><i class="fas fa-network-wired"></i> Network Advantages</h4>
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.9rem; color: #555;">Latency</p>
                                        <div style="font-size: 1.1rem; font-weight: 500; color: #f38020;">{{ how_cloudflare_help.network_advantages.latency }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.9rem; color: #555;">Network Capacity</p>
                                        <div style="font-size: 1.1rem; font-weight: 500; color: #f38020;">{{ how_cloudflare_help.network_advantages.capacity }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.9rem; color: #555;">Global Locations</p>
                                        <div style="font-size: 1.1rem; font-weight: 500; color: #f38020;">{{ how_cloudflare_help.network_advantages.locations }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.9rem; color: #555;">Direct Connections</p>
                                        <div style="font-size: 1.1rem; font-weight: 500; color: #f38020;">{{ how_cloudflare_help.network_advantages.connections }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Business Value -->
        <div class="tab-pane fade" id="value-content">
            <div class="section-padding">
                <h2 class="text-center mb-5"><i class="fas fa-chart-line"></i> Business Value with Cloudflare</h2>
                
                {% if business_value.value_propositions %}
                <div class="row mb-5">
                    {% for prop in business_value.value_propositions %}
                    <div class="col-lg-6 mb-4">
                        <div class="card card-hover h-100">
                            <div class="card-header bg-primary text-white">
                                <h5><i class="fas fa-{{ prop.icon }}"></i> {{ prop.title }}</h5>
                            </div>
                            <div class="card-body">
                                <p>{{ prop.description }}</p>
                                {% if prop.metrics %}
                                <div class="mt-3">
                                    {% for metric in prop.metrics %}
                                    <div class="alert alert-info mb-2">
                                        <strong>{{ metric.label }}:</strong> <span class="text-success">{{ metric.improvement }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if prop.learn_more %}
                                <div class="mt-3">
                                    {% for link in prop.learn_more %}
                                    <a href="{{ link.url }}" class="btn btn-sm btn-outline-primary me-2">{{ link.text }}</a>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if business_value.roi_summary %}
                <div class="row">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-center mb-4"><i class="fas fa-calculator"></i> ROI Summary</h3>
                                <div class="row text-center mb-4">
                                    <div class="col-md-3">
                                        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.9rem; color: #555;">Implementation Time</p>
                                        <div style="font-size: 1.1rem; font-weight: 500;" class="text-primary">{{ business_value.roi_summary.implementation_time }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.9rem; color: #555;">Payback Period</p>
                                        <div style="font-size: 1.1rem; font-weight: 500;" class="text-success">{{ business_value.roi_summary.payback_period }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.9rem; color: #555;">Annual Savings</p>
                                        <div style="font-size: 1.1rem; font-weight: 500;" class="text-warning">{{ business_value.roi_summary.annual_savings }}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.9rem; color: #555;">Revenue Impact</p>
                                        <div style="font-size: 1.1rem; font-weight: 500;" class="text-danger">{{ business_value.roi_summary.revenue_impact }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>

// Auto-advance demo sections (optional)
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dynamic Cloudflare Security Demo Presentation Ready');
    console.log('Content loaded from database - AI editable via MCP');
});
</script>

<!-- Embedded AI Assistant -->
<style>
    .ai-assistant-fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
    }
    .ai-fab-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        border: none;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(249, 115, 22, 0.4);
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .ai-fab-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(249, 115, 22, 0.6);
    }
    
    .ai-chat-panel {
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 400px;
        height: 600px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        flex-direction: column;
        z-index: 999;
    }
    .ai-chat-panel.active {
        display: flex;
    }
    
    .ai-chat-header {
        padding: 20px;
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .ai-chat-mode-toggle {
        display: flex;
        gap: 8px;
        background: rgba(255,255,255,0.2);
        padding: 4px;
        border-radius: 8px;
    }
    .ai-mode-btn {
        padding: 6px 12px;
        border: none;
        background: transparent;
        color: white;
        font-size: 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .ai-mode-btn.active {
        background: white;
        color: #f97316;
        font-weight: bold;
    }
    .ai-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
    }
    
    .ai-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }
    .ai-message {
        margin-bottom: 16px;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 85%;
    }
    .ai-message.user {
        background: #e3f2fd;
        margin-left: auto;
        text-align: right;
    }
    .ai-message.assistant {
        background: white;
        border: 1px solid #e0e0e0;
    }
    .ai-message.system {
        background: #fff3cd;
        font-size: 13px;
        text-align: center;
        margin: 0 auto;
    }
    
    .ai-chat-input {
        padding: 16px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 8px;
    }
    .ai-chat-input input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #d0d0d0;
        border-radius: 8px;
        font-size: 14px;
    }
    .ai-chat-input button {
        padding: 10px 20px;
        background: #f97316;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }
    .ai-chat-input button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
</style>

<div class="ai-assistant-fab">
    <button class="ai-fab-button" id="aiFabButton" title="AI Assistant">
        ðŸ¤–
    </button>
</div>

<div class="ai-chat-panel" id="aiChatPanel">
    <div class="ai-chat-header">
        <div>
            <h6 style="margin: 0;">AI Assistant</h6>
            <div class="ai-chat-mode-toggle">
                <button class="ai-mode-btn active" data-mode="user">ðŸ‘€ Read</button>
                <button class="ai-mode-btn" data-mode="admin">ðŸ”§ Edit</button>
            </div>
        </div>
        <button class="ai-close-btn" id="aiCloseBtn">Ã—</button>
    </div>
    
    <div class="ai-chat-messages" id="aiChatMessages">
        <div class="ai-message system">Select mode and ask about the presentation</div>
    </div>
    
    <div class="ai-chat-input">
        <input type="text" id="aiChatInput" placeholder="Ask about the presentation..." />
        <button id="aiSendBtn">Send</button>
    </div>
</div>

<script>
    let currentMode = 'user';
    let conversationHistory = [];
    let isProcessing = false;
    
    // UI Elements
    const fabButton = document.getElementById('aiFabButton');
    const chatPanel = document.getElementById('aiChatPanel');
    const closeBtn = document.getElementById('aiCloseBtn');
    const chatMessages = document.getElementById('aiChatMessages');
    const chatInput = document.getElementById('aiChatInput');
    const sendBtn = document.getElementById('aiSendBtn');
    const modeButtons = document.querySelectorAll('.ai-mode-btn');
    
    // Toggle panel
    fabButton.addEventListener('click', () => {
        chatPanel.classList.toggle('active');
    });
    
    closeBtn.addEventListener('click', () => {
        chatPanel.classList.remove('active');
    });
    
    // Mode switching
    modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            currentMode = mode;
            
            modeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Clear history and add mode message
            conversationHistory = [];
            chatMessages.innerHTML = '';
            
            const modeMsg = mode === 'user' 
                ? '<div class="ai-message system">ðŸ‘€ User Mode: Read-only access</div>'
                : '<div class="ai-message system">ðŸ”§ Admin Mode: Full edit access + auto-refresh</div>';
            chatMessages.innerHTML = modeMsg;
        });
    });
    
    // Send message
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || isProcessing) return;
        
        isProcessing = true;
        sendBtn.disabled = true;
        sendBtn.textContent = '...';
        chatInput.value = '';
        
        // Add user message
        addMessage(message, 'user');
        
        // Add to history
        conversationHistory.push({ role: 'user', content: message });
        if (conversationHistory.length > 6) {
            conversationHistory = conversationHistory.slice(-6);
        }
        
        // Show progress
        const progressMsg = addMessage('ðŸ¤– AI is thinking...', 'system');
        
        try {
            const endpoint = currentMode === 'user' ? '/api/ai-chat-user/' : '/api/ai-chat-admin/';
            
            // Show what AI is doing
            setTimeout(() => {
                if (isProcessing) {
                    progressMsg.textContent = currentMode === 'admin' 
                        ? 'ðŸ”„ AI is reading current content and preparing updates...'
                        : 'ðŸ“– AI is reading presentation content...';
                }
            }, 1500);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    message: message,
                    history: conversationHistory
                })
            });
            
            // Remove progress message
            progressMsg.remove();
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response:', text.substring(0, 200));
                addMessage('âŒ Server error: Expected JSON but got HTML. Check console for details.', 'system');
                isProcessing = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                return;
            }
            
            const data = await response.json();
            
            if (!response.ok) {
                addMessage('âŒ Server error: ' + (data.error || response.statusText), 'system');
            } else if (data.error) {
                addMessage('âŒ Error: ' + data.error, 'system');
            } else {
                addMessage(data.response, 'assistant');
                conversationHistory.push({ role: 'assistant', content: data.response });
                
                // Auto-refresh if admin mode and update detected
                if (currentMode === 'admin' && (
                    data.response.toLowerCase().includes('done') ||
                    data.response.toLowerCase().includes('updated') ||
                    data.response.toLowerCase().includes('changed')
                )) {
                    setTimeout(() => {
                        addMessage('ðŸ”„ Auto-refreshing presentation in 2 seconds...', 'system');
                        setTimeout(() => location.reload(), 2000);
                    }, 1000);
                }
            }
        } catch (error) {
            // Remove progress message if still there
            if (progressMsg && progressMsg.parentNode) {
                progressMsg.remove();
            }
            console.error('Fetch error:', error);
            addMessage('âŒ Network error: ' + error.message + '. Check your connection.', 'system');
        }
        
        isProcessing = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        chatInput.focus();
    }
    
    function addMessage(text, role) {
        const div = document.createElement('div');
        div.className = `ai-message ${role}`;
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return div; // Return element for removal/updates
    }
    
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>

{% endblock %}
